<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NewTimeAuto</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: #121212;
      color: white;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 1rem;
    }
    .car-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }
    .car-card {
      background: #1e1e1e;
      border-radius: 10px;
      overflow: hidden;
      padding: 1rem;
    }
    .car-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
    }
    .car-card h3 {
      margin: 0.5rem 0;
    }
    .btn {
      background: #0099ff;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      text-decoration: none;
      display: inline-block;
      margin-top: 0.5rem;
      cursor: pointer;
    }
    .details-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      overflow-y: auto;
      display: none;
      padding: 1rem;
    }
    .details-overlay.active {
      display: block;
    }
    .details-content img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .btn-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .btn-row .btn {
      flex: 1 1 45%;
    }
  </style>
</head>
<body>
  <div class="car-grid" id="carGrid">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <div class="details-overlay" id="detailsOverlay">
    <div class="top-bar">
      <button class="btn" onclick="closeDetails()">‚Üê –ù–∞–∑–∞–¥</button>
      <a id="shareBtn" class="btn" target="_blank">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</a>
    </div>
    <div id="detailsContent" class="details-content"></div>
  </div>

  <script>
  const urlParams = new URLSearchParams(window.location.search);
const carId = urlParams.get('id') || urlParams.get('startapp')?.replace('id_', '');

if (carId) {
  openCarModal(carId); // –∏–ª–∏ –ª—é–±–∞—è —Ç–≤–æ—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
}
  
    const tg = window.Telegram.WebApp;
    tg.expand?.();

    const SPREADSHEET_ID = "1e6MBPZ3vmYdgJRHLwQIw2Ehf7TFSdWycgJ9mYnM0Ahk";
    const API_KEY = "AIzaSyB7BDWOi1pICTSaN1SdUsdTKlgW1g-v_Vc";
    const RANGE = "–ù–∞–ª–∏—á–∏–µ";
    let cars = [];

    async function loadCars() {
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`);
      const { values } = await res.json();
      const headers = values[0];
      cars = values.slice(1).map(row => Object.fromEntries(headers.map((h, i) => [h, row[i]])));
      renderCars();
      handleStartParam();
    }

    function renderCars() {
      const grid = document.getElementById('carGrid');
      grid.innerHTML = '';
      cars.forEach(car => {
        const div = document.createElement('div');
        div.className = 'car-card';
        div.innerHTML = `
          <img src="${car.–§–æ—Ç–æ.split(',')[0].trim()}" alt="–§–æ—Ç–æ">
          <h3>${car.–ú–∞—Ä–∫–∞} ${car.–ú–æ–¥–µ–ª—å}</h3>
          <p>${car.–ì–æ–¥} ‚Ä¢ ${car["–¶–µ–Ω–∞, —Ä—É–±."]} ‚ÇΩ</p>
          <button class="btn" onclick="openDetails('${car.ID}')">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        `;
        grid.appendChild(div);
      });
    }

    function openDetails(id) {
      const car = cars.find(c => c.ID === id);
      if (!car) return;

      const images = car.–§–æ—Ç–æ.split(',').map(url => `<img src="${url.trim()}" alt="–§–æ—Ç–æ">`).join('');
      document.getElementById('detailsContent').innerHTML = `
        ${images}
        <h2>${car.–ú–∞—Ä–∫–∞} ${car.–ú–æ–¥–µ–ª—å}</h2>
        <p><strong>–ì–æ–¥:</strong> ${car.–ì–æ–¥}</p>
        <p><strong>–î–≤–∏–≥–∞—Ç–µ–ª—å:</strong> ${car.–î–≤–∏–≥–∞—Ç–µ–ª—å}, ${car.–û–±—ä–µ–º}–ª</p>
        <p><strong>–ü—Ä–∏–≤–æ–¥:</strong> ${car.–ü—Ä–∏–≤–æ–¥}</p>
        <p><strong>–¢—Ä–∞–Ω—Å–º–∏—Å—Å–∏—è:</strong> ${car.–¢—Ä–∞–Ω—Å–º–∏—Å—Å–∏—è}</p>
        <p><strong>–¶–µ–Ω–∞:</strong> ${car["–¶–µ–Ω–∞, —Ä—É–±."]} ‚ÇΩ</p>
        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong><br>${car.–û–ø–∏—Å–∞–Ω–∏–µ || '‚Äî'}</p>
        <div class="btn-row">
          <a class="btn" href="https://t.me/newtimeauto_sales?text=–•–æ—á—É –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å: ${encodeURIComponent(car.–ú–∞—Ä–∫–∞ + ' ' + car.–ú–æ–¥–µ–ª—å + ' (–∞—Ä—Ç. ' + car.ID + ')')}" target="_blank">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</a>
          <a class="btn" href="https://t.me/newtimeauto_sales?text=–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç: ${encodeURIComponent(car.–ú–∞—Ä–∫–∞ + ' ' + car.–ú–æ–¥–µ–ª—å + ' (–∞—Ä—Ç. ' + car.ID + ')')}" target="_blank">–ù–∞–ø–∏—Å–∞—Ç—å</a>
          <a class="btn" href="tel:+79512310445">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>
        </div>
      `;
      document.getElementById('shareBtn').href = `https://t.me/share/url?url=${encodeURIComponent('https://t.me/newtimeauto_bot/app?startapp=id_' + id)}&text=${encodeURIComponent('–°–º–æ—Ç—Ä–∏, —á—Ç–æ –Ω–∞—à—ë–ª –≤ –∫–∞—Ç–∞–ª–æ–≥–µ NewTimeAuto: ' + car.–ú–∞—Ä–∫–∞ + ' ' + car.–ú–æ–¥–µ–ª—å)}`;

      document.getElementById('detailsOverlay').classList.add('active');
    }

    function closeDetails() {
      document.getElementById('detailsOverlay').classList.remove('active');
    }

    function handleStartParam() {
      let id = tg?.initDataUnsafe?.start_param || new URLSearchParams(location.search).get('startapp') || '';
      if (id.startsWith('id_')) id = id.replace('id_', '');
      if (id) openDetails(id);
    }

    loadCars();
  </script>
</body>
</html>
